Title: 阴影家族速览表
Date: 2025-05-28
Category: 性能优化

# 阴影“大全套”——把所有常见影子招式掰开揉碎说一遍

> **核心比喻**：灯光 = 手电筒，阴影 = 手电照物体留下的黑影。做游戏就是想办法把这块黑影在屏幕上“糊”出来，既像样又省劲。  

---

## 0. 先背 3 句总口诀

1. **能糊别雕**：只在玩家眼前用高清影子，远处糊一点没人挑刺。  
2. **先贴后算**：能把影子当贴纸贴就别实时算光线。  
3. **分块更新**：一大张影子贵得要命，拆小块轮流洗最省。

---

## 1. 阴影家族速览（从“最抠门”到“最壕”）

| 阴影流派 | 通俗介绍 | 适用场景 | 性能费用 |
|-----------|---------|---------|---------|
| **Blob 投影** | 底下放一张椭圆贴纸 | 远景 NPC、低端机 | 最便宜 |
| **Projector / Decal** | 像投电影，把影子贴到地面 | 顶光、平地、2D 角色 | 便宜 |
| **Shadow Map** | “拍照法”——先照深度图，再对比 | 90% 实时光用它 | 中等 |
| &nbsp;&nbsp;• PCF 过滤 | 阴影边缘抹灰 | 硬阴影太锯齿时 | +10–20% |
| &nbsp;&nbsp;• CSM（级联系统） | 地面铺多张地毯 | 大世界太阳光 | +30–50% |
| &nbsp;&nbsp;• VSM / ESM | 数学变换一口气做软阴影 | 透贴很多时 | +10–30%，显存 ↑ |
| &nbsp;&nbsp;• PCSS | 阴影随距离变软 | 虚幻 UE5 默认 | 贵一些 |
| **Capsule / SDF** | 在骨骼绑胶囊体算阴影 | 角色自遮挡 | CPU 轻，GPU轻 |
| **Screen Space Contact Shadow** | 屏幕里像素自检“谁挡谁” | 脚贴地/接触缝隙 | 小贵，分辨率相关 |
| **Ray Traced Shadow** | 真光线，像现实 | 高端 PC/主机 | 最贵最真实 |

---

## 2. Shadow Map 体系——90% 项目都用它

### 2-1 单张 Shadow Map（点菜版）
1. 手电筒位置 → 把所有可见物体只画“深度快照”  
2. 着色时：  
   - 计算当前像素在手电坐标的“深度”  
   - 拿快照里的深度对比：**更远 = 在阴影里**  
3. 缺点：一张快照要管近+远，细节 or 视野要牺牲其一

### 2-2 CSM（分级地毯）
- 把视野切 3–4 圈，近圈用细毯，远圈用粗毯 → 解决“近糊”  
- 太阳转动 → 只要角度改变大于阈值再重烤地毯  
- 切缝处用淡化或过渡滤波

### 2-3 软阴影调味包
| 名称 | 说人话 | 代价 |
|------|--------|------|
| **PCF** | 多抖 3×3 取平均，“喷了雾” | 9 次采样 ↑ |
| **VSM / ESM** | 把深度预处理，软硬一步到位 | 显存 ↑，能漏光 |
| **PCSS** | 先找阴影边缘宽度，再自适应 PCF | 采样多，救写实感 |

---

## 3. 角色自遮挡专用

| 技术 | 比喻 | 用法 |
|------|------|------|
| **Capsule Shadow** | 在骨骼插几根“黑灯管” | EVA、MMO 手游标配 |
| **SDF Shadow** | 预烘三维距离场，像“果冻模型” | UE5 Nanite / 魔兽新引擎 |
| **SSCS** | 屏幕像素自己射小探针 | UE5 Lumen / Unity HDRP |

---

## 4. 极简“工程决策树”

1. **场景光源类型**  
   - 恒定方向（太阳）：CSM  
   - 点/聚光灯：单张 Shadow Map + PCF  
   - 多彩灯 / 反复开关：Forward+ + Tiled Shadow Atlas  
2. **预算不够？**  
   - 开 PCF? 先砍分辨率  
   - 远处乱跳？→ CSM + 分帧更新  
   - 手机烂？→ 远光直接 Blob / Capsule  
3. **写实 & 高端？**  
   - 关不上噪？→ VSM 或 PCSS  
   - 预算爆棚？→ Hybrid Ray Tracing（RTX 阴影仅给主光 / 关键灯）

---

## 5. 防坑小抄

| 症状 | 药方 |
|------|------|
| 阴影条纹（Acne） | 提升 bias：固定偏移 + 按坡度乘系数 |
| 浮空（Peter-Panning） | Bias 太大→减一点；或做 Slope Scale Bias |
| 阴影抖动 | 贴图原点对齐像素格 → “Stable” 模式 |
| 内存爆炸 | 远 cascade 分辨率 ↓；Atlas 动态分配 |
| 抖+糊 | Cascade 交界混合 / PCF 核动态调整 |

---

## 6. 一句话总结

> **“近用细毯、远铺草席；贴纸能糊就糊，软硬靠调味包；角色加胶囊，大光用地毯，豪机再上光追。”**  

掌握这张“影子菜单”，就能按项目成本随心点菜，既不糊得难看，也不烧钱烧帧。