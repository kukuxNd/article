Title: è™šæ„å‡½æ•°åœ¨C++&C#ä¸­çš„è¡¨ç°
Date: 2014-06-18
Category: UE45&Unity

å¥½é—®é¢˜ï¼è¿™èƒŒåçš„åŸå› è·Ÿ **è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰æœºåˆ¶** å’Œ **C++ çš„ææ„é¡ºåºè§„èŒƒ** æœ‰å…³ã€‚æˆ‘ä»¬ä¸€èµ·æ¥æ‹†å¼€è®²æ¸…æ¥šã€‚

---

## ğŸ¯ ä¸ºä»€ä¹ˆè™šææ„å‡½æ•°èƒ½å…ˆè°ƒ `~sub()` å†è°ƒ `~base()`ï¼Ÿ

### 1ï¸âƒ£ ææ„å‡½æ•°çš„è°ƒç”¨é¡ºåºè§„å®šï¼ˆè¿™æ˜¯è¯­è¨€è§„èŒƒï¼‰ï¼š
- **C++ æ ‡å‡†è§„å®šï¼šæ´¾ç”Ÿç±»å¯¹è±¡é”€æ¯æ—¶ï¼Œææ„é¡ºåºæ˜¯ï¼š**
  - **å…ˆæ‰§è¡Œæ´¾ç”Ÿç±»ææ„å‡½æ•° `~sub()`**
  - **å†æ‰§è¡ŒåŸºç±»ææ„å‡½æ•° `~base()`**

è¿™ä¸ªé¡ºåºçš„ç›®çš„æ˜¯ï¼š
> å­ç±»å¯èƒ½æ‹¥æœ‰è‡ªå·±çš„èµ„æºï¼ˆæ¯”å¦‚ new å‡ºæ¥çš„å¯¹è±¡ï¼‰ï¼Œéœ€è¦å…ˆé‡Šæ”¾ï¼›
> ç„¶åå†é‡Šæ”¾å…¬å…±åŸºç±»æ‹¥æœ‰çš„èµ„æºã€‚

---

### 2ï¸âƒ£ å…³é”®ç‚¹ï¼š**ä½ æ˜¯é€šè¿‡ `base*` æŒ‡é’ˆåœ¨ delete å¯¹è±¡**

```cpp
base* p = new sub();
delete p;  // è¿™é‡Œè°ƒç”¨çš„æ˜¯å“ªä¸ªææ„å‡½æ•°ï¼Ÿ
```

- å¦‚æœ `~base()` **ä¸æ˜¯è™šå‡½æ•°**ï¼š  
  C++ ç¼–è¯‘å™¨åªçŸ¥é“è¿™æ˜¯ä¸ª `base` ç±»å‹çš„æŒ‡é’ˆï¼Œå®ƒåªä¼šé™æ€åœ°è°ƒç”¨ `~base()`ï¼Œæ ¹æœ¬ä¸ä¼šå»æŸ¥ `~sub()`ã€‚

- å¦‚æœ `~base()` æ˜¯ **è™šå‡½æ•°**ï¼š  
  ç¼–è¯‘å™¨ä¼šé€šè¿‡ `vtable` æ¥åŠ¨æ€å†³å®šè¦è°ƒç”¨çš„æ˜¯ `~sub()`ï¼ˆå³æ´¾ç”Ÿç±»çš„ææ„ï¼‰ã€‚

---

### 3ï¸âƒ£ vtable æ˜¯æ€ä¹ˆå¸®åŠ©åšåˆ°è¿™ä¸€ç‚¹çš„ï¼Ÿ

æ¯ä¸ªå¸¦è™šå‡½æ•°çš„ç±»éƒ½æœ‰ä¸€å¼ â€œè™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰â€ï¼Œ  
å½“ä½  new ä¸€ä¸ª `sub` å¯¹è±¡æ—¶ï¼Œå®ƒçš„ vtable æŒ‡å‘çš„æ˜¯ `sub` çš„ç‰ˆæœ¬ï¼Œé‡Œé¢çš„ `~base()` æŒ‡é’ˆä¼šè¢« override æˆ `~sub()`ã€‚

äºæ˜¯ delete æ—¶ï¼š

```cpp
// å‡è®¾ä½ å†™äº† virtual ~base()ï¼Œdelete ä¼šè¿™æ ·åšï¼š
base* p = new sub();  // å®é™…ä¸Šæ˜¯ sub å¯¹è±¡
delete p;  // ä¼šå» vtable æŸ¥ ~sub()ï¼Œå†éšå¼é“¾åˆ° ~base()
```

æµç¨‹å¦‚ä¸‹ï¼š

1. æŸ¥æ‰¾ vtable â†’ æ‰¾åˆ° `~sub()`
2. è°ƒç”¨ `~sub()` â†’ æ´¾ç”Ÿç±»èµ„æºé‡Šæ”¾
3. ç„¶åè‡ªåŠ¨è°ƒç”¨ `~base()` â†’ åŸºç±»èµ„æºé‡Šæ”¾

---

## ğŸ”¥ ä¸åŠ  virtual çš„åæœï¼Ÿ

```cpp
class base {
public:
    ~base() { std::cout << "~ base\n"; }
};

class sub : public base {
public:
    ~sub() { std::cout << "~ sub\n"; }
};

base* p = new sub();
delete p;  // è¾“å‡ºï¼Ÿ
```

è¾“å‡ºï¼š

```
~ base
```

**Oopsï¼`~sub()` å®Œå…¨æ²¡è°ƒç”¨ã€‚**  
å¦‚æœ `~sub()` é‡Œé¢é‡Šæ”¾äº†èµ„æºï¼ˆæ¯”å¦‚ delete ä¸€ä¸ªæŒ‡é’ˆï¼‰ï¼Œå°±æ³„æ¼äº†ã€‚

---

## âœ… æ€»ç»“

| æ˜¯å¦åŠ  `virtual` | delete æ—¶æ˜¯å¦è°ƒåˆ° `~sub()` | å®‰å…¨æ€§ | æ¨è |
|------------------|----------------------------|--------|------|
| âŒ éè™šææ„å‡½æ•°   | âŒ ä¸è°ƒï¼Œå¯èƒ½å†…å­˜æ³„æ¼       | âŒ ä¸å®‰å…¨ | âŒ |
| âœ… è™šææ„å‡½æ•°     | âœ… å…ˆè°ƒ `~sub()` å†è°ƒ `~base()` | âœ… å®‰å…¨é‡Šæ”¾ | âœ… |

---

å¥½å˜ï¼æˆ‘ä»¬æ¥æä¸€ä¸ª **C# å° demo**ï¼Œæ¼”ç¤ºï¼š

1. âœ… ææ„å‡½æ•° `~ClassName()`ï¼ˆFinalizerï¼‰æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼ˆä½†æ—¶é—´ä¸ç¡®å®šï¼‰  
2. âœ… å¦‚ä½•ç”¨ `IDisposable` + `Dispose()` æ¥ **æ‰‹åŠ¨æ§åˆ¶èµ„æºé‡Šæ”¾**ï¼Œæ¨¡æ‹Ÿ C++ ææ„è¡Œä¸º  
3. âœ… `GC.Collect()` å¯ä»¥â€œå¼ºè¡Œå¬å”¤â€åƒåœ¾å›æ”¶ï¼ˆä½†ä¸æ¨èåœ¨çº¿ç¨‹é€»è¾‘ä¸­ä¾èµ–ï¼‰

---

## ğŸ’¡ ä»£ç ç¤ºä¾‹ï¼šC# ææ„ vs Dispose

```csharp
using System;

class Finalizable : IDisposable {
    private string name;

    public Finalizable(string name) {
        this.name = name;
        Console.WriteLine($"{name} æ„é€ å®Œæˆ");
    }

    // ææ„å‡½æ•°ï¼ˆGCè°ƒç”¨æ—¶è§¦å‘ï¼‰
    ~Finalizable() {
        Console.WriteLine($"{name} çš„ææ„å‡½æ•°ï¼ˆFinalizerï¼‰è¢« GC è°ƒç”¨äº†");
    }

    // æ˜¾å¼é‡Šæ”¾èµ„æº
    public void Dispose() {
        Console.WriteLine($"{name} æ˜¾å¼ Dispose() è¢«è°ƒç”¨");
        GC.SuppressFinalize(this); // å‘Šè¯‰ GCï¼šè¿™ä¸ªå¯¹è±¡æˆ‘è‡ªå·±å¤„ç†äº†ï¼Œä¸ç”¨å†è°ƒ finalizer
    }
}

class Program {
    static void Main() {
        Console.WriteLine("ğŸ”¸ è¿›å…¥ Main æ–¹æ³•");

        // ç”¨ using ç»“æ„ï¼Œè‡ªåŠ¨è°ƒç”¨ Dispose
        using (var obj1 = new Finalizable("å¯¹è±¡1")) {
            Console.WriteLine("ğŸ§ª ä½¿ç”¨ å¯¹è±¡1 ä¸­...");
        }

        // æ‰‹åŠ¨ newï¼Œä½†ä¸ Dispose
        var obj2 = new Finalizable("å¯¹è±¡2");

        Console.WriteLine("ğŸ”¸ æ‰‹åŠ¨ new çš„å¯¹è±¡2ï¼Œä¸è°ƒç”¨ Disposeï¼Œç­‰å¾… GC");

        // å¼ºè¡Œè§¦å‘ GC
        GC.Collect();
        GC.WaitForPendingFinalizers();

        Console.WriteLine("ğŸ”¸ Main æ–¹æ³•ç»“æŸ");
    }
}
```

---

## ğŸ§ª è¾“å‡ºå¯èƒ½æ˜¯ï¼ˆé¡ºåºç•¥æœ‰å˜åŒ–ï¼‰ï¼š

```
ğŸ”¸ è¿›å…¥ Main æ–¹æ³•
å¯¹è±¡1 æ„é€ å®Œæˆ
ğŸ§ª ä½¿ç”¨ å¯¹è±¡1 ä¸­...
å¯¹è±¡1 æ˜¾å¼ Dispose() è¢«è°ƒç”¨
å¯¹è±¡2 æ„é€ å®Œæˆ
ğŸ”¸ æ‰‹åŠ¨ new çš„å¯¹è±¡2ï¼Œä¸è°ƒç”¨ Disposeï¼Œç­‰å¾… GC
å¯¹è±¡2 çš„ææ„å‡½æ•°ï¼ˆFinalizerï¼‰è¢« GC è°ƒç”¨äº†
ğŸ”¸ Main æ–¹æ³•ç»“æŸ
```

---

## ğŸ” è§‚å¯Ÿè¦ç‚¹ï¼š

| è¡Œä¸º                       | è¡¨ç°                           |
|----------------------------|--------------------------------|
| using å—ç»“æŸåè‡ªåŠ¨è°ƒç”¨ Dispose | âœ… æ‰‹åŠ¨é‡Šæ”¾èµ„æº                  |
| ææ„å‡½æ•°ä»€ä¹ˆæ—¶å€™è§¦å‘        | â“ å–å†³äº GCï¼Œä¸å¯é¢„æµ‹ï¼Œé™¤éæ‰‹åŠ¨ `Collect()` |
| `GC.SuppressFinalize(this)` | ğŸ§¹ é¿å…å¤šæ¬¡æ¸…ç†                 |

---

## ğŸ§  å°ç»“ & å»ºè®®

| å¦‚æœä½ æƒ³è¦...                         | æ¨èåšæ³•                    |
|----------------------------------------|-----------------------------|
| åƒ C++ é‚£æ ·ç¡®å®šé‡Šæ”¾èµ„æº              | å®ç° `IDisposable` + `using`|
| æƒ³äº†è§£ GC çš„ finalizer æ‰§è¡Œæœºåˆ¶     | å†™ `~ClassName()` çœ‹ GC è°ƒç”¨ |
| æƒ³æ‰‹åŠ¨é‡Šæ”¾èµ„æºå¹¶é¿å… GC ç®¡è¿™äº‹        | ç”¨ `Dispose()` + `SuppressFinalize()` |

---
å¥½é—®é¢˜ï¼ä½ çš„æé—®éå¸¸â€œè¾¹ç•Œæµ‹è¯•ç²¾ç¥â€â€”â€”è¿™ç§åœºæ™¯åœ¨çœŸå®é¡¹ç›®é‡Œç¡®å®å®¹æ˜“è¸©å‘ã€‚

---

## ğŸ¯ ç®€çŸ­å›ç­”ï¼š

âŒ **ä¸å¯ä»¥**ã€‚  
ä¸€æ—¦ä½ è°ƒç”¨äº† `reader.Dispose()`ï¼Œå†è°ƒç”¨ `reader.ReadToEnd()` ç­‰æ–¹æ³•ï¼Œ**å°†æŠ›å‡ºå¼‚å¸¸**ï¼š

```csharp
System.ObjectDisposedException: Cannot access a closed StreamReader.
```

---

## ğŸ’¥ ä¸¾ä¸ªå®é™…ä¾‹å­ï¼š

```csharp
StreamReader reader = new StreamReader("example.txt");
reader.Dispose();  // æ˜¾å¼é‡Šæ”¾

// â—å†è°ƒç”¨ ReadToEnd ä¼šæŠ¥é”™
string content = reader.ReadToEnd();  // Boom!
```

### è¾“å‡ºé”™è¯¯ï¼š

```
Unhandled exception. System.ObjectDisposedException: Cannot access a closed StreamReader.
```

---

## ğŸ§  ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

å› ä¸ºï¼š

1. `Dispose()` ä¼šå°†å†…éƒ¨ `Stream` ç½®ä¸º null æˆ–å…³é—­çŠ¶æ€
2. `StreamReader` æ¯æ¬¡è¯»æ•°æ®éƒ½ä¼šæ£€æŸ¥å†…éƒ¨æµæ˜¯å¦æœ‰æ•ˆ
3. ä¸€æ—¦å‘ç°æ˜¯å·²é‡Šæ”¾çš„çŠ¶æ€ï¼Œå°±ç›´æ¥æŠ›å‡º `ObjectDisposedException`

è¿™æ˜¯ä¸€ç§â€œä¿æŠ¤æœºåˆ¶â€ï¼Œ**é˜²æ­¢ä½ å¯¹å·²ç»è¢«æ¸…ç†çš„èµ„æºåšæ— æ•ˆæ“ä½œ**ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ›´ä¸¥é‡çš„é—®é¢˜ï¼ˆæ¯”å¦‚å†…å­˜æ³„æ¼ã€æ­»é”ã€æ•°æ®ç ´åç­‰ï¼‰

---

## âœ… æ­£ç¡®ç”¨æ³•æ€»ç»“

| æ“ä½œ                   | æ˜¯å¦å®‰å…¨ | è¯´æ˜                           |
|------------------------|----------|--------------------------------|
| `ReadToEnd()` æ­£å¸¸ä½¿ç”¨ | âœ…       | å‰ææ˜¯è¿˜æ²¡ Dispose             |
| Dispose åå†è¯»         | âŒ       | æŠ¥é”™ `ObjectDisposedException` |
| å¤šæ¬¡ Dispose()         | âœ…       | å¤šæ¬¡ Dispose ä¸ä¼šæŠ¥é”™ï¼Œæ˜¯å¹‚ç­‰æ“ä½œ |

---

## âœ¨ Bonusï¼šå¦‚ä½•ä¼˜é›…åˆ¤æ–­æ˜¯å¦å·² Disposeï¼Ÿ

æ ‡å‡†ç±»å¦‚ `StreamReader` **æ²¡æœ‰å…¬å¼€æä¾› `IsDisposed`** æ ‡å¿—ã€‚  
å¦‚æœä½ å†™çš„æ˜¯è‡ªå·±çš„ç±»ï¼Œå¯ä»¥è¿™æ ·åšï¼š

```csharp
private bool _disposed = false;

public void Dispose() {
    if (!_disposed) {
        // é‡Šæ”¾èµ„æº
        _disposed = true;
    }
}
```

---

## æ€»ç»“å£æ’­ç‰ˆğŸ—£ï¸ï¼š

> `Dispose()` å°±åƒä½ æŠŠä¹¦åˆä¸Šã€ç¯å…³äº†ã€é—¨é”ä¸Šäº†ã€‚
> å†æƒ³è¯»ï¼Ÿå¯¹ä¸èµ·ï¼Œç¯é»‘äº†ï¼Œé—¨é”äº†ï¼Œç³»ç»Ÿç›´æ¥æ‰”ä½ ä¸€ä¸ª `ObjectDisposedException` â€”â€” **åˆ«å›å¤´çœ‹ï¼Œèµ¶ç´§å¦èµ·ç‚‰ç¶ï¼**

---

ç»å¦™çš„é—®é¢˜ï¼è¿™ä¸€é—®ç›´å‡» C# å’Œ Unity å¼€å‘çš„**è¯­è¨€è¾¹ç•Œè¡Œä¸º**ï¼

---

## ğŸ¯ ç­”æ¡ˆç®€æ´ç‰ˆï¼š

âŒ **ä¸èƒ½ç”¨**ã€‚  
å¦‚æœä¸€ä¸ªç±»å‹**æ²¡æœ‰å®ç° `IDisposable` æ¥å£**ï¼Œä½  **ä¸èƒ½ç”¨ `using` è¯­æ³•**ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ã€‚

---

## ğŸ“Œ ç¼–è¯‘å™¨ä¼šæŠ¥ä»€ä¹ˆé”™ï¼Ÿ

å¦‚æœä½ å†™äº†ï¼š

```csharp
class MyClass {
    // æ²¡æœ‰å®ç° IDisposable
}

void Start() {
    using (var obj = new MyClass()) {
        // ...
    }
}
```

ä½ ä¼šå¾—åˆ°å¦‚ä¸‹ç¼–è¯‘é”™è¯¯ï¼ˆä»¥ Unity å’Œ VS ä¸ºä¾‹ï¼‰ï¼š

```
error CS1674: 'MyClass': type used in a using statement must be implicitly convertible to 'System.IDisposable'
```

---

## ğŸ” ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

`using` æ˜¯ C# çš„è¯­æ³•ç³–ï¼Œç­‰æ•ˆäºï¼š

```csharp
{
    MyClass obj = new MyClass();
    try {
        // ...
    }
    finally {
        if (obj != null)
            ((IDisposable)obj).Dispose();
    }
}
```

æ‰€ä»¥ä½ å¿…é¡»å®ç° `IDisposable`ï¼Œå¦åˆ™å®ƒ**ä¸çŸ¥é“å»å“ªå„¿æ‰¾ `.Dispose()` æ–¹æ³•æ¥é‡Šæ”¾èµ„æº**ã€‚

---

## âœ… æ­£ç¡®ç”¨æ³•æ¨¡æ¿ï¼š

```csharp
class MyDisposable : IDisposable {
    public void Dispose() {
        Console.WriteLine("èµ„æºè¢«é‡Šæ”¾äº†");
    }
}

void Start() {
    using (var obj = new MyDisposable()) {
        // è‡ªåŠ¨é‡Šæ”¾
    }
}
```

---

## ğŸ§  Unity ä¸­çš„ç‰¹ä¾‹ï¼šä¸€äº› UnityEngine ç±»å‹è™½ç„¶æœ‰ `.Dispose()`ï¼Œä½†ä¸èƒ½ç”¨ `using`ï¼

æ¯”å¦‚ `RenderTexture.Release()`ã€`Texture.Destroy()`ï¼š

```csharp
RenderTexture rt = new RenderTexture(...);
rt.Release();  // ä¸æ˜¯ IDisposableï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ using
```

è¿™ç±»å¯¹è±¡ä¸å®ç° `IDisposable`ï¼Œä½ åªèƒ½æ‰‹åŠ¨ç®¡ç†ã€‚

---
