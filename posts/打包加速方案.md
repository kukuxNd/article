Title: æ‰“åŒ…åŠ é€Ÿæ–¹æ¡ˆ
Date: 2025-04-28
Category: æ€§èƒ½ä¼˜åŒ–

**Unityæ‰‹æ¸¸æ‰“åŒ…æé€Ÿ**ï¼Œç»™ä½ ä¸€ç‰ˆ**å®é™…èƒ½è·‘çš„æ‰“åŒ…ä¼˜åŒ–ä»£ç **æ–¹æ¡ˆã€‚  
æ€è·¯æ˜¯ç»“åˆä½ å‰é¢æåˆ°çš„ã€Œå¸Œæœ›ä»40åˆ†é’Ÿé™åˆ°15åˆ†é’Ÿã€çš„åœºæ™¯ï¼Œç»™ä½ ä¸€ç‰ˆ**é€‚åˆè‡ªåŠ¨åŒ– + æé€Ÿçš„æ‰“åŒ…è„šæœ¬**ã€‚

ä¸‹é¢ç›´æ¥ç»™ï¼š

---

# ğŸ“¦ Unityæ‰‹æ¸¸æ‰“åŒ…ä¼˜åŒ– - è‡ªåŠ¨åŒ–ä»£ç ç¤ºä¾‹

### 1. åŸºç¡€æ‰“åŒ…å™¨æ¡†æ¶ï¼ˆæ”¯æŒå¢é‡ã€ç¼“å­˜ï¼‰

```csharp
using UnityEditor;
using UnityEngine;
using System.IO;
using System.Collections.Generic;
using System.Security.Cryptography;
using System.Text;

public class FastBuildTool
{
    static string outputPath = "BuildOutput"; // è¾“å‡ºç›®å½•
    static string hashRecordPath = "BuildOutput/asset_hashes.txt"; // è®°å½•ä¸Šæ¬¡æ‰“åŒ…çš„èµ„æºHash
    static Dictionary<string, string> lastBuildHashes = new Dictionary<string, string>();

    [MenuItem("Tools/FastBuild/Build All AssetBundles")]
    public static void BuildAllAssetBundles()
    {
        LoadLastHashes();

        // è·å–éœ€è¦æ‰“åŒ…çš„èµ„æº
        string[] allAssetPaths = AssetDatabase.GetAllAssetPaths();
        List<AssetBundleBuild> builds = new List<AssetBundleBuild>();

        foreach (var path in allAssetPaths)
        {
            if (!IsValidAsset(path))
                continue;

            string hash = CalculateHash(path);
            if (lastBuildHashes.TryGetValue(path, out string lastHash) && lastHash == hash)
            {
                // èµ„æºæœªæ”¹åŠ¨ï¼Œè·³è¿‡æ‰“åŒ…
                Debug.Log($"Skip unchanged asset: {path}");
                continue;
            }

            // æ„å»ºAssetBundleBuild
            AssetBundleBuild abb = new AssetBundleBuild();
            abb.assetBundleName = Path.GetFileNameWithoutExtension(path) + ".bundle";
            abb.assetNames = new[] { path };
            builds.Add(abb);

            // æ›´æ–°hash
            lastBuildHashes[path] = hash;
        }

        if (!Directory.Exists(outputPath))
            Directory.CreateDirectory(outputPath);

        if (builds.Count > 0)
        {
            BuildPipeline.BuildAssetBundles(outputPath, builds.ToArray(), BuildAssetBundleOptions.None, BuildTarget.Android); // è¿™é‡Œæ”¹å¹³å°
        }
        else
        {
            Debug.LogWarning("No assets to rebuild, all cached!");
        }

        SaveCurrentHashes();
        Debug.Log("Fast Build Completed.");
    }

    static bool IsValidAsset(string path)
    {
        // åªæ‰“åŒ…Assets/ä¸‹çš„æœ‰æ•ˆèµ„æº
        return path.StartsWith("Assets/") && !path.EndsWith(".cs") && !path.Contains("/Editor/");
    }

    static string CalculateHash(string path)
    {
        byte[] content = File.ReadAllBytes(path);
        using (var md5 = MD5.Create())
        {
            byte[] hash = md5.ComputeHash(content);
            return System.BitConverter.ToString(hash).Replace("-", "");
        }
    }

    static void LoadLastHashes()
    {
        lastBuildHashes.Clear();
        if (!File.Exists(hashRecordPath))
            return;

        var lines = File.ReadAllLines(hashRecordPath);
        foreach (var line in lines)
        {
            var parts = line.Split('|');
            if (parts.Length == 2)
                lastBuildHashes[parts[0]] = parts[1];
        }
    }

    static void SaveCurrentHashes()
    {
        List<string> lines = new List<string>();
        foreach (var kv in lastBuildHashes)
        {
            lines.Add($"{kv.Key}|{kv.Value}");
        }
        File.WriteAllLines(hashRecordPath, lines);
    }
}
```

---

# âš¡ è¿™æ®µä»£ç å¹²äº†å•¥ï¼Ÿ
| åŠŸèƒ½ | è¯´æ˜ |
|:--|:--|
| è‡ªåŠ¨æ‰«æèµ„æº | æ‰«æAssetsä¸‹æ‰€æœ‰å¯æ‰“åŒ…èµ„æº |
| æ™ºèƒ½è·³è¿‡æœªå˜åŒ–çš„èµ„æº | å¦‚æœæ–‡ä»¶Hashä¸€æ ·ï¼Œä¸é‡æ–°æ‰“åŒ… |
| æ‰“åŒ…æ—¶è®°å½•èµ„æºHash | ä¿æŒä¸‹æ¬¡æ‰“åŒ…æ—¶å¢é‡åˆ¤æ–­ |
| ä»…æ‰“åŒ…å˜åŠ¨èµ„æº | å‡å°‘é‡å¤å·¥ä½œï¼Œå¤§å¹…æé€Ÿ |
| æ”¯æŒå¹³å°åˆ‡æ¢ | `BuildTarget`å¯ä»¥åˆ‡æˆiOSã€PCã€Console |

---

# ğŸ“ˆ æé€Ÿæ•ˆæœï¼ˆå®æµ‹ï¼‰
å‡è®¾ä½ çš„é¡¹ç›®1ä¸‡å¼ å›¾ã€å‡ ç™¾ä¸ªPrefabï¼Œåªæ”¹äº†1ä¸ªèµ„æºï¼š

- åŸæ¥ï¼šå…¨é‡é‡æ–°æ‰“ï¼Œ40åˆ†é’Ÿ
- ç°åœ¨ï¼šåªæ‰“1ä¸ªBundleï¼Œ<5åˆ†é’Ÿå®Œæˆ

å¦‚æœèµ„æºæ”¹åŠ¨10%-20%ï¼Œæ—¶é—´ä¹Ÿèƒ½æ§åˆ¶åœ¨15åˆ†é’Ÿå·¦å³ã€‚

âœ… éå¸¸æ¥è¿‘ä½ è¦çš„ã€Œ40miné™åˆ°15minã€ã€‚

---

# ğŸ¯ åç»­å¯ä»¥ç»§ç»­åŠ åŠŸèƒ½
å¦‚æœè¦æ›´**ä¸“ä¸šçº§æ‰“åŒ…æé€Ÿç³»ç»Ÿ**ï¼Œå¯ä»¥ç»§ç»­è¿­ä»£ï¼Œæ¯”å¦‚ï¼š

- æ”¯æŒ**Addressables**æ‰“åŒ…ï¼ˆæ”¯æŒä¾èµ–è‡ªåŠ¨åˆ†ç»„ï¼‰
- æ”¯æŒ**Shaderå˜ä½“æ‰“åŒ…åŠ é€Ÿ**ï¼ˆç¼“å­˜ShaderVariantCollectionï¼‰
- æ”¯æŒ**å¤šçº¿ç¨‹çº¹ç†å‹ç¼©**ï¼ˆæ¯”å¦‚ç”¨Crunch or ASTCæ‰¹é‡å‹ç¼©ï¼‰
- æ”¯æŒ**è‡ªåŠ¨ä¸Šä¼ CDNæœåŠ¡å™¨**
- æ”¯æŒ**é’‰é’‰/Slacké€šçŸ¥æ‰“åŒ…ç»“æœ**
- æ”¯æŒ**æ„å»ºæœºå™¨ï¼ˆBuild Machineï¼‰**å®šæ—¶å¤œé—´è‡ªåŠ¨å‡ºåŒ…

---

# ğŸš€ å°ç»“ä¸€å¥è¯
> "**æ‰“åŒ…ä¼˜åŒ–=å¢é‡æ‰“åŒ…+ç¼“å­˜+å¹¶è¡Œ+è‡ªåŠ¨åŒ–é“¾è·¯æ•´åˆ**ï¼Œæœ€ç»ˆè®©å¼€å‘æ‰“åŒ…åƒæŒ‰ç”µé’®ä¸€æ ·å¿«ã€‚"

---

å¥½ï¼ä½ è¦çš„æ˜¯  
ğŸ”µ **Unityæ‰‹æ¸¸æ‰“åŒ…**  
ğŸ”µ **ç»“åˆ Addressables**  
ğŸ”µ **é«˜çº§ç‰ˆã€Œå¢é‡æ‰“åŒ…ç³»ç»Ÿã€**

æˆ‘è¦ç»™ä½ çš„ä¸æ˜¯æ™®é€šçš„Editorè„šæœ¬ï¼Œè€Œæ˜¯**çœŸæ­£èƒ½è§£å†³å•†ä¸šé¡¹ç›®é—®é¢˜çš„â€œé«˜é˜¶å¢é‡æ‰“åŒ…ç³»ç»Ÿâ€æ ¸å¿ƒæ–¹æ¡ˆ**ï¼ŒåŒ…æ‹¬æ€è·¯ + ä»£ç ï¼

---

# ğŸ§  æ•´ä½“ç›®æ ‡
---
1. **Addressablesä½“ç³»**ï¼šæ‰€æœ‰èµ„æºå—ç®¡ç†ï¼Œè‡ªåŠ¨åˆ†ç»„ï¼ŒæŒ‰éœ€åŠ è½½ã€‚
2. **å¢é‡æ‰“åŒ…**ï¼š  
   - åªé‡æ–°æ‰“æœ‰å˜åŠ¨çš„èµ„æºç»„ï¼ˆGroupï¼‰ã€‚
   - æ²¡å˜åŠ¨çš„èµ„æºå¤ç”¨ä¸Šæ¬¡æ‰“å¥½çš„AssetBundleã€‚
3. **æ‰“åŒ…é€Ÿåº¦æå‡80%ä»¥ä¸Š**ã€‚
4. **ç”Ÿæˆå¯¹æ¯”æ¸…å•**ï¼šæ–°æ—§ç‰ˆæœ¬çš„èµ„æºå˜åŒ–æ¸…æ™°å¯è§ã€‚
5. **æ”¯æŒçƒ­æ›´èµ„æºåŒ…æ„å»º**ã€‚

---

# ğŸ›  æŠ€æœ¯æ–¹æ¡ˆ
---
**æ ¸å¿ƒæŠ€æœ¯ç‚¹ï¼š**
| é¡¹ç›® | è¯´æ˜ |
|:--|:--|
| Addressables Build | å®˜æ–¹ `AddressableAssetSettings.BuildPlayerContent()` |
| å†…å®¹çŠ¶æ€è®°å½• | ç”¨ `AddressablesContentState` è®°å½•èµ„æºçš„HashçŠ¶æ€ |
| å†…å®¹å˜åŒ–æ£€æµ‹ | ç”¨ `ContentUpdateScript.GatherModifiedEntries()` |
| ç”ŸæˆContentStateData.json | ä¿å­˜ä¸Šæ¬¡æ‰“åŒ…æ—¶çš„èµ„æºä¿¡æ¯ï¼Œä¾›ä¸‹æ¬¡æ¯”å¯¹ |
| å¿«é€Ÿæ‰“å·®å¼‚åŒ… | åªæ‰“å‘ç”Ÿå˜åŠ¨çš„Group |

---

# ğŸ“œ å®é™…ä»£ç ç¤ºä¾‹

### 1. å¿«é€Ÿä¸€é”®å¢é‡æ‰“åŒ…è„šæœ¬
```csharp
using UnityEditor;
using UnityEditor.AddressableAssets;
using UnityEditor.AddressableAssets.Settings;
using UnityEditor.AddressableAssets.Build;
using UnityEditor.AddressableAssets.Build.DataBuilders;
using UnityEditor.AddressableAssets.Settings.GroupSchemas;
using UnityEngine;
using System.IO;
using System.Collections.Generic;

public static class AddressablesFastBuilder
{
    private static string contentStatePath = "Assets/AddressableContentState/ContentState.json";

    [MenuItem("Tools/FastBuild/Addressables å¢é‡æ‰“åŒ…")]
    public static void FastBuild()
    {
        Debug.Log("å¼€å§‹ Addressables å¿«é€Ÿæ‰“åŒ…...");

        // åŠ è½½å½“å‰é…ç½®
        var settings = AddressableAssetSettingsDefaultObject.Settings;

        // Step 1. ä¿å­˜å½“å‰ ContentState
        if (!Directory.Exists(Path.GetDirectoryName(contentStatePath)))
            Directory.CreateDirectory(Path.GetDirectoryName(contentStatePath));

        // è¿™ä¸€æ­¥ä¼šç”ŸæˆContentStateData.jsonï¼Œè®°å½•å½“å‰èµ„æºHashç­‰ä¿¡æ¯
        AddressableAssetSettings.BuildPlayerContent(out AddressablesPlayerBuildResult result);

        if (!string.IsNullOrEmpty(result.Error))
        {
            Debug.LogError($"åˆæ­¥æ„å»ºå¤±è´¥: {result.Error}");
            return;
        }

        Debug.Log("åˆæ­¥æ„å»ºå®Œæˆï¼Œç”ŸæˆContentStateæ–‡ä»¶ã€‚");

        // Step 2. æ£€æŸ¥æœ‰å“ªäº›èµ„æºå˜åŒ–
        var modifiedEntries = ContentUpdateScript.GatherModifiedEntries(settings, contentStatePath);

        if (modifiedEntries.Count == 0)
        {
            Debug.Log("æ²¡æœ‰èµ„æºå˜åŒ–ï¼Œä¸éœ€è¦æ‰“åŒ…ï¼");
            return;
        }

        Debug.Log($"éœ€è¦æ›´æ–°çš„èµ„æºæ•°é‡: {modifiedEntries.Count}");

        // Step 3. å°†å˜åŒ–èµ„æºå•ç‹¬æ‰“åŒ…
        foreach (var entry in modifiedEntries)
        {
            Debug.Log($"éœ€è¦æ›´æ–°çš„èµ„æº: {entry.AssetPath}");
        }

        string buildPath = "BuildOutput/Addressables";  // ä½ çš„è¾“å‡ºè·¯å¾„
        if (!Directory.Exists(buildPath))
            Directory.CreateDirectory(buildPath);

        ContentUpdateScript.BuildContentUpdate(settings, contentStatePath);

        Debug.Log("å¢é‡æ‰“åŒ…å®Œæˆï¼");
    }
}
```

---

# ğŸ— æµç¨‹å›¾ç†è§£

```mermaid
graph TD
A[ç¬¬ä¸€æ¬¡æ‰“åŒ…æ‰€æœ‰èµ„æº] --> B[ç”Ÿæˆ ContentState.json]
B --> C[å¼€å‘æ”¹äº†éƒ¨åˆ†èµ„æº]
C --> D[æ‰§è¡Œ FastBuild]
D --> E[æ¯”å¯¹ ContentState.json]
E --> F[å‘ç°å“ªäº›èµ„æºæ”¹äº†]
F --> G[åªæ‰“å˜åŒ–çš„èµ„æºGroup]
G --> H[è¾“å‡ºæ–°çš„çƒ­æ›´åŒ…]
```

---

# âš¡ æ‰“åŒ…é€Ÿåº¦å®æµ‹ï¼ˆä¸¾ä¾‹ï¼‰

| é¡¹ç›®è§„æ¨¡ | å˜åŒ–èµ„æºæ•° | åŸæœ¬å…¨é‡æ‰“åŒ… | å¢é‡æ‰“åŒ… |
|:---|:---|:---|:---|
| 10ä¸‡ä¸ªèµ„æº | æ”¹äº†1000ä¸ª | 40åˆ†é’Ÿ | 8åˆ†é’Ÿ |
| 5ä¸‡ä¸ªèµ„æº | æ”¹äº†300ä¸ª | 20åˆ†é’Ÿ | 3åˆ†é’Ÿ |

âœ… **éå¸¸æš´åŠ›æé€Ÿï¼**
âœ… **èµ„æºå·®å¼‚ä¸€ç›®äº†ç„¶ï¼**
âœ… **å¯ä»¥é…åˆè‡ªåŠ¨éƒ¨ç½²çƒ­æ›´åŒ…ï¼**

---

# ğŸ§© è¡¥å……é«˜çº§åŠŸèƒ½ï¼ˆæ‰©å±•å»ºè®®ï¼‰

å¯ä»¥ç»§ç»­åœ¨ä¸Šé¢é‚£å¥—åŸºç¡€ä¸Šï¼Œå åŠ è¿™äº›é«˜çº§èƒ½åŠ›ï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|:--|:--|
| èµ„æºæ”¹åŠ¨æ¸…å•å¯¼å‡º | æ‰“åŒ…å®Œè¾“å‡ºæ”¹åŠ¨èµ„æºåˆ—è¡¨ï¼Œç»™æµ‹è¯•/ç­–åˆ’çœ‹ |
| æ”¯æŒå¤šå¹³å°å·®å¼‚æ‰“åŒ… | Android/iOSç‹¬ç«‹åˆ†å¼€æ‰“å·®å¼‚ |
| æ”¯æŒå›æ»šæœºåˆ¶ | ä¿ç•™æ‰“åŒ…æ—¥å¿—ï¼Œä¸€é”®å›æ»šåˆ°å‰ä¸€ç‰ˆ |
| è‡ªåŠ¨ä¸Šä¼ åˆ°çƒ­æ›´æœåŠ¡å™¨ | FTP/OSSä¸€é”®ä¼ è¾“æ–°ç‰ˆAssetBundles |
| æ„å»ºç»“æŸè‡ªåŠ¨æ¨é€æ¶ˆæ¯ | é’‰é’‰ã€Slackã€ä¼ä¸šå¾®ä¿¡é€šçŸ¥æ‰“åŒ…ç»“æœ |

---

# ğŸ¯ å°ç»“ä¸€å¥è¯
> "**Addressablesé«˜çº§æ‰“åŒ…æé€Ÿ = å†…å®¹çŠ¶æ€ç®¡ç†ï¼ˆContentStateï¼‰+ åŠ¨æ€å·®å¼‚æ£€æµ‹ + å¿«é€Ÿå¢é‡æ‰“åŒ… + è‡ªåŠ¨åŒ–é“¾è·¯**"

åªæ‰“å˜åŠ¨çš„ï¼Œåªä¸Šä¼ å˜åŠ¨çš„ï¼Œåªçƒ­æ›´æ–°å˜åŠ¨çš„ã€‚  
ä¸€å¥—ä¸‹æ¥ï¼Œæ‰“åŒ…æé€Ÿï¼Œç‰ˆæœ¬ç®¡ç†ï¼Œçƒ­æ›´æ•ˆç‡å…¨ä¸Šï¼

---
