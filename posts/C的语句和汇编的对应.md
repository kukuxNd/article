Title: Cè¯­å¥å’Œæ±‡ç¼–çš„å¯¹åº”
Date: 2024-09-18
Category: C&C++

æˆ‘ä»¬æ¥ç³»ç»Ÿåœ°æ¢³ç† **C è¯­è¨€çš„åŸºæœ¬è¯­æ³•ã€å˜é‡ç±»å‹åŠèµ‹å€¼æ–¹å¼**ï¼Œå¹¶é€šè¿‡ç®€å•ç¤ºä¾‹ï¼Œ**åˆ—å‡ºå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ï¼ˆä»¥ x86-64 AT&T è¯­æ³•ä¸ºä¾‹ï¼‰**ï¼Œå¸®åŠ©ä½ ç†è§£ä» C åˆ°æ±‡ç¼–çš„åº•å±‚å¯¹åº”å…³ç³»ã€‚

---

## ğŸ§± ä¸€ã€C è¯­è¨€åŸºæœ¬è¯­æ³•ç»“æ„

| è¯­æ³•åˆ†ç±» | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| å˜é‡å£°æ˜ | `int a;` | å£°æ˜ä¸€ä¸ªæ•´å‹å˜é‡ |
| èµ‹å€¼ | `a = 10;` | ç»™å˜é‡èµ‹å€¼ |
| è¡¨è¾¾å¼ | `b = a + 3;` | è¡¨è¾¾å¼æ±‚å€¼å¹¶èµ‹å€¼ |
| æ¡ä»¶è¯­å¥ | `if (a > 5) {...}` | åˆ†æ”¯ |
| å¾ªç¯è¯­å¥ | `while (a < 100) {...}` | å¾ªç¯ |
| å‡½æ•°å®šä¹‰ | `int sum(int x, int y)` | å®šä¹‰å‡½æ•° |
| æ•°ç»„ | `int arr[5];` | å®šä¹‰æ•°ç»„ |
| æŒ‡é’ˆ | `int *p = &a;` | ä½¿ç”¨åœ°å€å’ŒæŒ‡é’ˆ |
| ç»“æ„ä½“ | `struct S { int a; float b; };` | ç”¨æˆ·è‡ªå®šä¹‰ç±»å‹ |

---

## ğŸ“Œ äºŒã€åŸºæœ¬ç±»å‹ä¸èµ‹å€¼ï¼ˆå¸¦æ±‡ç¼–å¯¹ç…§ï¼‰

### 1ï¸âƒ£ æ•´å‹ï¼ˆ`int`ï¼‰

```c
int a = 10;
```

**å¯¹åº”æ±‡ç¼–ï¼ˆx86-64 AT&Tï¼‰ï¼š**
```asm
movl $10, -4(%rbp)   # å‡è®¾ a åœ¨æ ˆå¸§ä¸­åç§» -4
```

---

### 2ï¸âƒ£ å­—ç¬¦å‹ï¼ˆ`char`ï¼‰

```c
char c = 'A';
```

**æ±‡ç¼–ï¼š**
```asm
movb $65, -1(%rbp)   # 'A' çš„ ASCII æ˜¯ 65
```

---

### 3ï¸âƒ£ çŸ­æ•´å‹ï¼ˆ`short`ï¼‰

```c
short s = 300;
```

**æ±‡ç¼–ï¼š**
```asm
movw $300, -2(%rbp)
```

---

### 4ï¸âƒ£ é•¿æ•´å‹ï¼ˆ`long`ï¼‰

```c
long l = 123456789L;
```

**æ±‡ç¼–ï¼š**
```asm
movq $123456789, -8(%rbp)
```

---

### 5ï¸âƒ£ æµ®ç‚¹å‹ï¼ˆ`float`ï¼‰

```c
float f = 3.14f;
```

**æ±‡ç¼–ï¼ˆéœ€ç”¨ SSEï¼‰ï¼š**
```asm
movss .LC0(%rip), %xmm0  # .LC0 æ˜¯å¸¸é‡æ± ä¸­3.14çš„ä½ç½®
movss %xmm0, -4(%rbp)
```

---

### 6ï¸âƒ£ åŒç²¾åº¦ï¼ˆ`double`ï¼‰

```c
double d = 6.28;
```

**æ±‡ç¼–ï¼š**
```asm
movsd .LC1(%rip), %xmm0
movsd %xmm0, -8(%rbp)
```

---

### 7ï¸âƒ£ å­—ç¬¦ä¸²èµ‹å€¼ï¼ˆ`char*`ï¼‰

```c
char* str = "Hello";
```

**æ±‡ç¼–ï¼š**
```asm
movq $.LC2, -8(%rbp)    # .LC2 æ˜¯å­—ç¬¦ä¸²å¸¸é‡ "Hello" çš„åœ°å€
```

---

## âš™ï¸ ä¸‰ã€å¸¸è§èµ‹å€¼è¡¨è¾¾å¼å’Œæ±‡ç¼–

### ğŸ“Œ `a = b + c;`

```c
int a, b = 3, c = 4;
a = b + c;
```

**æ±‡ç¼–ï¼š**
```asm
movl -8(%rbp), %eax    # b
addl -12(%rbp), %eax   # c
movl %eax, -4(%rbp)    # a
```

---

### ğŸ“Œ `a++;` å’Œ `++a;`

```c
int a = 5;
a++;
```

**æ±‡ç¼–ï¼š**
```asm
addl $1, -4(%rbp)
```

```c
++a;
```

**åŒä¸Šï¼Œæ±‡ç¼–ä¸åŒºåˆ†å‰åç¼€å¢é‡åœ¨åº•å±‚å®ç°**

---

### ğŸ“Œ æŒ‡é’ˆèµ‹å€¼ä¸è§£å¼•ç”¨

```c
int a = 10;
int *p = &a;
*p = 20;
```

**æ±‡ç¼–ï¼š**
```asm
movl $10, -4(%rbp)         # a = 10
leaq -4(%rbp), %rax        # p = &a
movq %rax, -16(%rbp)
movl $20, (%rax)           # *p = 20
```

---

## ğŸ§  å››ã€ç±»å‹å¤§å°ï¼ˆx86-64ï¼‰

| ç±»å‹ | å¤§å° (å­—èŠ‚) |
|------|--------------|
| `char` | 1 |
| `short` | 2 |
| `int` | 4 |
| `long` | 8 |
| `float` | 4 |
| `double` | 8 |
| `pointer` | 8 |

---

## ğŸ“œ äº”ã€å¸¸è§æ±‡ç¼–æŒ‡ä»¤ç®€æï¼ˆAT&Tï¼‰

| æŒ‡ä»¤ | å«ä¹‰ |
|------|------|
| `movl/movq/movb` | æ•°æ®ç§»åŠ¨ |
| `addl/addq` | åŠ æ³• |
| `subl/subq` | å‡æ³• |
| `imul` | ä¹˜æ³• |
| `idiv` | é™¤æ³• |
| `leaq` | è·å–åœ°å€ |
| `cmp` | æ¯”è¾ƒï¼ˆç”¨äºæ¡ä»¶è·³è½¬ï¼‰ |
| `jmp/jne/je` | æ— æ¡ä»¶/æ¡ä»¶è·³è½¬ |
| `call/ret` | å‡½æ•°è°ƒç”¨ä¸è¿”å› |

---
å¤ªå¥½äº†ï¼ä¸‹é¢æˆ‘ä»¬å°†é€šè¿‡ **3 ä¸ªå®Œæ•´çš„ C å‡½æ•°** ç¤ºä¾‹ï¼Œå±•ç¤ºï¼š

1. å‡½æ•°å‚æ•°ä¼ é€’  
2. å±€éƒ¨å˜é‡åˆ†é…  
3. è¿ç®—ä¸è¿”å›å€¼å¤„ç†  
4. å¯¹åº”çš„ **x86-64 AT&T æ±‡ç¼–æŒ‡ä»¤**ï¼ˆå¸¦æ³¨é‡Šï¼‰

---

## âœ… ç¤ºä¾‹ 1ï¼šç®€å•åŠ æ³•å‡½æ•°

```c
int add(int a, int b) {
    int result = a + b;
    return result;
}
```

### æ±‡ç¼–ä»£ç ï¼ˆx86-64 AT&T è¯­æ³•ï¼‰ï¼š
```asm
add:
    pushq %rbp                # ä¿å­˜ä¸Šä¸€ä¸ªæ ˆå¸§æŒ‡é’ˆ
    movq %rsp, %rbp           # è®¾ç½®å½“å‰æ ˆå¸§

    movl %edi, -4(%rbp)       # a å­˜å…¥æ ˆå¸§çš„ -4
    movl %esi, -8(%rbp)       # b å­˜å…¥æ ˆå¸§çš„ -8

    movl -4(%rbp), %eax       # eax = a
    addl -8(%rbp), %eax       # eax += b

    popq %rbp                 # æ¢å¤æ ˆå¸§
    ret                       # è¿”å› eaxï¼ˆå‡½æ•°è¿”å›å€¼ï¼‰
```

> ğŸ’¡ å‡½æ•°å‚æ•° `a` å’Œ `b` åˆ†åˆ«é€šè¿‡ `edi`ã€`esi` ä¼ å…¥ã€‚

---

## âœ… ç¤ºä¾‹ 2ï¼šå¸¦å±€éƒ¨å˜é‡ã€ä¹˜æ³•å’Œè¿”å›å€¼

```c
int mul_add(int x, int y) {
    int product = x * y;
    int sum = product + x;
    return sum;
}
```

### æ±‡ç¼–ä»£ç ï¼š
```asm
mul_add:
    pushq %rbp
    movq %rsp, %rbp

    movl %edi, -4(%rbp)       # x
    movl %esi, -8(%rbp)       # y

    movl -4(%rbp), %eax       # eax = x
    imull -8(%rbp), %eax      # eax *= y
    movl %eax, -12(%rbp)      # product = eax

    movl -12(%rbp), %eax      # eax = product
    addl -4(%rbp), %eax       # eax += x

    popq %rbp
    ret
```

> ğŸ§  `imull` è¡¨ç¤ºæœ‰ç¬¦å·æ•´æ•°ä¹˜æ³•ï¼Œç»“æœå­˜åœ¨ `eax` ä¸­ã€‚

---

## âœ… ç¤ºä¾‹ 3ï¼šä½¿ç”¨æŒ‡é’ˆæ“ä½œå†…å­˜

```c
void set_value(int *p, int v) {
    *p = v;
}
```

### æ±‡ç¼–ä»£ç ï¼š
```asm
set_value:
    pushq %rbp
    movq %rsp, %rbp

    movq %rdi, -8(%rbp)       # p
    movl %esi, -12(%rbp)      # v

    movq -8(%rbp), %rax       # rax = p
    movl -12(%rbp), %edx      # edx = v
    movl %edx, (%rax)         # *p = v

    popq %rbp
    ret
```

> ğŸ” `rdi` å’Œ `esi` æ˜¯å‰ä¸¤ä¸ªå‚æ•°ï¼Œ`*p = v` å®é™…ç­‰ä»·äº `movl` åˆ° `[p]` æŒ‡å‘çš„å†…å­˜ã€‚

---

## ğŸš€ å»¶ä¼¸ï¼šå‡½æ•°è¿”å›ç±»å‹ä¸å¯„å­˜å™¨

| è¿”å›ç±»å‹ | å¯„å­˜å™¨ | è¯´æ˜ |
|----------|--------|------|
| `int` / `char` / `short` | `eax` | æ•´æ•°è¿”å›å€¼ |
| `float` | `xmm0` | å•ç²¾åº¦è¿”å› |
| `double` | `xmm0` | åŒç²¾åº¦è¿”å› |
| `long` / `pointer` | `rax` | 64ä½æ•´å‹æˆ–åœ°å€ |

---

## ğŸ” æç¤ºï¼šGCC ç”Ÿæˆæ±‡ç¼–æŸ¥çœ‹å‘½ä»¤

ä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç›´æ¥å°† `.c` æ–‡ä»¶è½¬ä¸ºæ±‡ç¼–ä»£ç ï¼š

```bash
gcc -S -masm=att -O0 demo.c -o demo.s
```

- `-S`ï¼šåªç¼–è¯‘ç”Ÿæˆæ±‡ç¼–
- `-masm=att`ï¼šæŒ‡å®šä½¿ç”¨ AT&T æ±‡ç¼–è¯­æ³•
- `-O0`ï¼šå…³é—­ä¼˜åŒ–ï¼Œä¾¿äºå­¦ä¹ 

---
å¤ªå¥½äº†ï¼Œå’±ä»¬æ¥ä¸€æ³¢ç¡¬æ ¸è¿›é˜¶ç‰ˆï¼ŒæŠŠ C ä¸­çš„é«˜çº§è¯­æ³•ä¸€ä¸€æ‹¿å‡ºæ¥å¯¹åº”æ±‡ç¼–ï¼ˆx86-64, AT&T è¯­æ³•ï¼‰ï¼Œæ¯ä¸ªä¾‹å­éƒ½æ˜¯å®æˆ˜ä¸­éå¸¸å¸¸è§çš„æ¨¡å¼ï¼Œå¹¶é…è¯¦ç»†æ³¨é‡Šè¯´æ˜ã€‚

---

## âœ… 1. å‡½æ•°è°ƒç”¨ï¼ˆå«å‚æ•°ä¼ é€’ã€è¿”å›å€¼ï¼‰

### C ç¤ºä¾‹
```c
int square(int x) {
    return x * x;
}

int main() {
    int y = square(3);
    return y;
}
```

### æ±‡ç¼–æ ¸å¿ƒé€»è¾‘ï¼ˆmain å†…éƒ¨ï¼‰ï¼š
```asm
movl $3, %edi          # å‡½æ•°å‚æ•° x = 3 â†’ ä¼ å…¥ %edi
call square            # è°ƒç”¨ square(x)
movl %eax, -4(%rbp)    # è¿”å›å€¼ä¿å­˜åœ¨ %eax â†’ å­˜å…¥ y
```

---

## âœ… 2. å‡½æ•°æŒ‡é’ˆ & å›è°ƒå‡½æ•°

### C ç¤ºä¾‹
```c
int add(int a, int b) {
    return a + b;
}

int compute(int (*op)(int, int), int x, int y) {
    return op(x, y);  // å‡½æ•°æŒ‡é’ˆè°ƒç”¨
}
```

### æ±‡ç¼–æ ¸å¿ƒï¼ˆè°ƒç”¨ `op(x, y)`ï¼‰ï¼š
```asm
movq -8(%rbp), %rax     # å‡½æ•°æŒ‡é’ˆ op â†’ %rax
movl -12(%rbp), %edi    # å‚æ•° x â†’ %edi
movl -16(%rbp), %esi    # å‚æ•° y â†’ %esi
call *%rax              # é—´æ¥è°ƒç”¨å‡½æ•°æŒ‡é’ˆ
```

> ğŸ§  å‡½æ•°æŒ‡é’ˆè°ƒç”¨ä½¿ç”¨ `call *%rax`ï¼Œè€Œä¸æ˜¯ `call label`ã€‚

---

## âœ… 3. æ•°ç»„è®¿é—®

### C ç¤ºä¾‹
```c
int arr[5] = {1, 2, 3, 4, 5};
int x = arr[2];   // è®¿é—®ç¬¬3ä¸ªå…ƒç´ 
```

### æ±‡ç¼–ï¼š
```asm
movl arr+8(%rip), %eax   # æ¯ä¸ª int å  4 å­—èŠ‚ï¼Œarr[2] åœ¨åç§» 8
movl %eax, -4(%rbp)
```

> ğŸ§  é™æ€æ•°ç»„åœ¨ `.data` åŒºï¼Œå¯¹åº”æ±‡ç¼–ä¸­çš„ç¬¦å·åœ°å€è®¿é—®ã€‚

---

## âœ… 4. ç»“æ„ä½“è®¿é—®

### C ç¤ºä¾‹
```c
struct Point {
    int x;
    int y;
};

struct Point p = {10, 20};
int sum = p.x + p.y;
```

### æ±‡ç¼–ï¼š
```asm
movl p(%rip), %eax       # p.x
addl p+4(%rip), %eax     # p.y åŠ åˆ° eax
movl %eax, -4(%rbp)
```

> ğŸ§  `p+4` æ˜¯ç»“æ„ä½“å†…åç§»è®¿é—®ï¼Œx åœ¨åç§» 0ï¼Œy åœ¨åç§» 4ã€‚

---

## âœ… 5. for å¾ªç¯

### C ç¤ºä¾‹
```c
int sum = 0;
for (int i = 0; i < 10; i++) {
    sum += i;
}
```

### æ±‡ç¼–ï¼ˆé€»è¾‘ç®€åŒ–ï¼‰ï¼š
```asm
movl $0, -4(%rbp)        # sum = 0
movl $0, -8(%rbp)        # i = 0

.Lloop:
cmpl $10, -8(%rbp)       # if i >= 10
jge .Lend

movl -8(%rbp), %eax
addl %eax, -4(%rbp)      # sum += i

addl $1, -8(%rbp)        # i++
jmp .Lloop

.Lend:
```

---

## âœ… 6. while å¾ªç¯

```c
int i = 0;
while (i < 5) {
    i++;
}
```

### æ±‡ç¼–ï¼š
```asm
movl $0, -4(%rbp)

.Lloop:
cmpl $5, -4(%rbp)
jge .Lexit

addl $1, -4(%rbp)
jmp .Lloop

.Lexit:
```

---

## âœ… 7. æŒ‡é’ˆè®¿é—®æ•°ç»„

```c
int arr[3] = {5, 10, 15};
int *p = arr;
int x = *(p + 1); // arr[1]
```

### æ±‡ç¼–ï¼š
```asm
leaq arr(%rip), %rax     # rax = &arr[0]
movq %rax, -8(%rbp)      # p = arr

movq -8(%rbp), %rax      # å–å‡º p
movl 4(%rax), %eax       # *(p + 1) â†’ æ¯ä¸ªint 4å­—èŠ‚
movl %eax, -4(%rbp)
```

---

## âœ… 8. ç»“æ„ä½“ + æŒ‡é’ˆè®¿é—®

```c
struct Point { int x; int y; };
struct Point p = {3, 7};
struct Point* ptr = &p;
int v = ptr->y;
```

### æ±‡ç¼–ï¼š
```asm
leaq p(%rip), %rax       # &p
movq %rax, -8(%rbp)      # ptr = &p

movq -8(%rbp), %rax
movl 4(%rax), %eax       # ptr->y åç§» 4
movl %eax, -4(%rbp)
```

---

## âœ… 9. æŒ‡é’ˆæ•°ç»„ + é—´æ¥è°ƒç”¨å‡½æ•°æŒ‡é’ˆ

```c
int add(int a, int b) { return a + b; }
int sub(int a, int b) { return a - b; }

int (*ops[2])(int, int) = {add, sub};
int r = ops[1](10, 3);  // è°ƒç”¨ sub
```

### æ±‡ç¼–å…³é”®æ®µï¼š
```asm
movq ops+8(%rip), %rax   # å–å‡º ops[1]
movl $10, %edi
movl $3, %esi
call *%rax               # é—´æ¥è°ƒç”¨ sub
```

---

## âš™ï¸ è¿›é˜¶æŠ€å·§æ±‡æ€»

| C åŠŸèƒ½ | æ±‡ç¼–å…³é”®æ“ä½œ |
|--------|----------------|
| å‡½æ•°å‚æ•°ä¼ é€’ | `rdi`, `rsi`, `rdx`, `rcx`, `r8`, `r9` |
| è¿”å›å€¼ | `rax`ï¼ˆæ•´æ•°/æŒ‡é’ˆï¼‰ï¼Œ`xmm0`ï¼ˆæµ®ç‚¹ï¼‰ |
| å‡½æ•°æŒ‡é’ˆè°ƒç”¨ | `call *%rax` |
| æŒ‡é’ˆè®¿é—®ç»“æ„ä½“æˆå‘˜ | `mov offset(%reg), %reg2` |
| for/while è·³è½¬ | `jmp`, `cmp`, `jl/jg/jz/jnz` |

---
