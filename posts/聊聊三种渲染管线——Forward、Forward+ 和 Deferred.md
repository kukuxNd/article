Title: 聊聊三种渲染管线——Forward、Forward+ 和 Deferred
Date: 2023-04-28
Category: 图形渲染

咱们就拿「做饭」和「流水线」来打个比方，用最接地气的方式聊聊三种渲染管线——Forward、Forward+ 和 Deferred。

---

## 1. Forward 渲染：点菜到上桌

- **流程**：想象你在小饭馆里点菜，服务员一份菜一份菜地送到你桌上。  
  1. 按顺序处理每个物体（菜品）。  
  2. 对每个物体，按它受哪些光源（调料）影响，一次性烹饪好，直接上桌。

- **特点**  
  - 简单直观：菜一做好马上上桌，不用二次加工。  
  - 光源（调料）多了就得一份菜加一份调料，成本成倍涨。

- **优缺点**  
  - ✅ 透明物体自然支持（酱汁、汤什 么都能当菜端上来）。  
  - ❌ 同时上桌的“调料”太多时，就得给每道菜反复加料，效率低。

---

## 2. Forward+ 渲染：半成品自助区

- **流程**：在小饭馆里改装了一块“半成品自助区”。  
  1. 先把菜放到自助区里，大厨只负责把菜基本炒好。  
  2. 自助区里有分区：像是辣区、咸区、甜区（Cluster）；  
  3. 服务员只从自助区里拿出当前这道菜附近对应的调料，不用把整个厨房所有调料都拿出来。

- **特点**  
  - 把“哪些调料该给这道菜”这件事提前做成分区管理。  
  - 真正加料的时候，只挑当前分区的小罐子，既快又干净。

- **优缺点**  
  - ✅ 当光源（调料）很多时，至少不必给每道菜都搬一大堆调料过来，只搬小份。  
  - ❌ 自助区搭建要花心思（分区算法要实现），透明菜还是一份一份处理。

---

## 3. Deferred 渲染：中央大厨房＋调料台

- **流程**：  
  1. **第一步：中央大厨房**——把所有菜（几何信息）切好、腌好，统一放到大冰箱里（G-Buffer），分格存放：蔬菜箱、肉类箱、调料箱……  
  2. **第二步：调料台**——在一个专门的调料台（Lighting Pass）上，对每道菜从冰箱里拿原料，再按所有调料配方一锅煮好。

- **特点**  
  - 厨师（几何）和调料员（光照）彻底分工：冰箱里东西随便放，想加什么随时去拿。  
  - 光源再多，也不需要再进厨房去一次次处理菜，只要在调料台上多放点调料就行。

- **优缺点**  
  - ✅ 海量调料（光源）也不怕，放调料台就好。  
  - ❌ 光照和材质解耦，但冰箱和调料台之间来回搬运（读写 G-Buffer）带宽大，尤其在手机上费劲。  
  - ❌ 透明菜（半透明物体）和 MSAA（硬件多重采样）在调料台上不好处理，需要特殊加菜方式（额外 Pass）。

---

### 最简对比

| 方案      | 比喻               | 好处                         | 坏处                         |
|---------|------------------|----------------------------|----------------------------|
| Forward | 点菜到上桌            | 实时简单，支持所有菜系             | 多菜多调料效率急剧下降           |
| Forward+| 半成品自助区          | 调料拿小份，减少搬运                 | 分区成本高，透明菜还得点菜处理     |
| Deferred| 中央大厨房＋调料台     | 调料无限加，极致光源扩展               | 冰箱↔调料台搬运成本高，透明菜麻烦  |

用这种“厨房＋菜＋调料”的比喻，一听就明白：  
- **Forward** 就是边做菜边加料；  
- **Forward+** 则先分好料区，再去拿应付；  
- **Deferred** 则彻底把菜、料分离，料集中在调料台。  

可以，把三种管线各取所长，做一个混合管线，并用简单的“做饭”成本模型给你算一算。假设：

- **场景组成**  
  - 80% 的不透明物体（重度光照）→ 用 Deferred  
  - 15% 的半透明／中等光源聚集物体 → 用 Forward+  
  - 5% 的完全透明或特殊效果（玻璃、水等）→ 用传统 Forward  

- **每帧耗时假设**  
  1. **Deferred 部分**  
     - G-Buffer 写入：0.8 ms  
     - 光照累加：1.0 ms  
     - 合计：1.8 ms  
  2. **Forward+ 部分**（Cluster 分区 + 光照限制）  
     - Cluster 分区开销：0.1 ms  
     - 每簇光照计算：0.2 ms  
     - 合计：0.3 ms  
  3. **Forward 部分**（透明物体）  
     - 逐物体光照：0.2 ms  

- **总体耗时**  
  把三者加起来，就是混合管线每帧大致的渲染开销：  
  ```
  T_total = T_deferred + T_forward+ + T_forward
          = 1.8 ms      + 0.3 ms         + 0.2 ms
          = 2.3 ms
  ```

---

### 通俗比喻  
- **Deferred（中央大厨房）**：  
  你先把 80% 的菜【不透明物体】都切好、腌好，放冰箱（G-Buffer），再一次性到调料台（Lighting Pass）加料——花 1.8 ms。  
- **Forward+（半成品自助区）**：  
  对 15% 的菜【半透明／中等复杂物体】，先按口味分区，只带小罐调料过去，加起来 0.3 ms。  
- **Forward（点菜到上桌）**：  
  最后 5% 的“汤、酱汁”【纯透明特效】，端上来单独再加调料，0.2 ms。

这样既保留了 Deferred 高光照吞吐的优势，也用 Forward+ 控制了中等光源密度部分的开销，同时对透明物体依然用简单的 Forward，不拉高复杂度。最终平均一帧只要 **2.3 ms**，兼顾了效果和性能。